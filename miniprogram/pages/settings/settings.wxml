<!-- 设置页（TDesign Weixin） -->
<view class="page">
  <view class="header">
    <view class="title">设置</view>
  </view>

  <view class="section">
    <view class="card">
      <view class="card-title">相册导出</view>
      <view class="card-desc">导出作品到系统相册需要 <text class="em">scope.writePhotosAlbum</text> 授权。</view>
      <view class="card-actions">
        <t-button theme="primary" size="small" bindtap="onRequestAlbumAuth">申请授权</t-button>
        <t-button variant="outline" theme="default" size="small" bindtap="onOpenSetting">去设置</t-button>
      </view>
    </view>
  </view>
  
  <view class="section">
    <t-cell-group>
      <t-cell title="常驻背景选择" description="{{selectedBgFileName || '选择应用常驻背景图片'}}" bindtap="onGoBgSelect" arrow />
      <t-cell title="毛笔练习" description="进入毛笔字练习模式" bindtap="onGoBrush" arrow />
      <t-cell title="相册" description="查看所有热力图作品" bindtap="onGoAlbum" arrow />
      <t-cell title="清理缓存" description="删除本地临时文件与缩略图（不删除作品库索引）">
        <view slot="note">
          <t-button variant="outline" size="small" theme="default" bindtap="onClearCache">清理</t-button>
        </view>
      </t-cell>
      <t-cell title="撤回步数上限" description="点击修改" note="{{maxUndoSteps}}" bindtap="onEditUndoLimit" arrow />
      <t-cell title="退出时提示保存" description="若有未保存更改，退出编辑页时进行提示">
        <t-switch slot="note" value="{{exitConfirm}}" bind:change="onExitConfirmChange" />
      </t-cell>
    </t-cell-group>
  </view>
  
  <view class="section">
    <view class="card">
      <view class="card-title">云存储</view>
      <view class="card-desc">从云存储读取图片文件</view>
      <view class="card-actions">
        <t-button theme="primary" size="small" bindtap="onLoadCloudImage">读取云存储</t-button>
      </view>
      <view class="cloud-image-container" wx:if="{{cloudImageUrl}}">
        <image class="cloud-image" src="{{cloudImageUrl}}" mode="aspectFit"></image>
      </view>
    </view>
  </view>

  <!-- 蓝牙打印机设置 -->
  <view class="section">
    <view class="card">
      <view class="card-title">蓝牙打印机</view>
      <view class="card-desc">设置蓝牙打印机连接，用于作品打印。</view>
      <view class="card-actions">
        <t-button theme="primary" size="small" bindtap="clickStartScanBleDevice" disabled="{{isScanning}}">
          {{isScanning ? '搜索中...' : '搜索设备'}}
        </t-button>
        <t-button variant="outline" theme="default" size="small" bindtap="clickDisconnectBleDevice" disabled="{{!connectedDevice}}">
          断开连接
        </t-button>
      </view>
      <view class="connection-status" wx:if="{{connectedDevice}}">
        <text class="status-label">已连接设备:</text>
        <text class="status-value">{{connectedDevice.name || connectedDevice.deviceId}}</text>
      </view>
      <!-- 设备列表 -->
      <view class="device-list" wx:if="{{blueList.length > 0 || isScanning}}">
        <view wx:if="{{isScanning && blueList.length === 0}}" class="no-devices">
          正在搜索蓝牙设备...
        </view>
        <view wx:for="{{blueList}}" wx:key="deviceId" class="device-item" bindtap="clickConnectBleDevice" data-device="{{item}}">
          <view class="device-info">
            <view class="device-name">{{item.name || '未知设备'}}</view>
            <view class="device-id">ID: {{item.deviceId}}</view>
          </view>
          <view class="device-status">
            <t-icon name="check-circle" wx:if="{{connectedDevice && connectedDevice.deviceId === item.deviceId}}" size="24" color="#07c160" />
            <t-icon name="chevron-right" wx:else size="20" color="#86909c" />
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="bottom">
    <t-button variant="outline" theme="default" block bindtap="onBackHome">返回作品库</t-button>
  </view>

  <t-dialog
    visible="{{limitDialogVisible}}"
    title="设置撤回步数上限"
    confirm-btn="确定"
    cancel-btn="取消"
    bind:confirm="onLimitConfirm"
    bind:cancel="onLimitCancel"
  >
    <t-input
      slot="content"
      borderless
      class="dialog-input"
      clearable
      placeholder="请输入数字(5-20)"
      value="{{tempLimitValue}}"
      type="number"
      bind:change="onLimitInputChange"
    />
  </t-dialog>
</view>


<!-- 绘画编辑页（TDesign Weixin） -->
<view class="page">
  <!-- 顶部操作栏 -->
  <view class="top-bar">
    <view class="top-left">
      <view class="circle-btn {{!canUndo ? 'disabled' : ''}}" bindtap="onUndo">
        <image class="btn-icon" src="../../images/undo.svg" mode="aspectFit"></image>
      </view>
      <view class="circle-btn {{!canRedo ? 'disabled' : ''}}" bindtap="onRedo">
        <image class="btn-icon" src="../../images/redo.svg" mode="aspectFit"></image>
      </view>
    </view>

    <view class="circle-btn" bindtap="openTools">调节</view>

    <view class="top-right">
      <view class="rect-btn primary" bindtap="onSave" style="position: relative;">
        完成
        <!-- 二维码浮层 -->
        <view class="qrcode-popup" wx:if="{{qrCodeUrl}}" catchtap="preventBubble">
          <image class="qrcode-img" src="{{qrCodeUrl}}" show-menu-by-longpress mode="aspectFit"/>
          <view class="qrcode-tip">微信扫码，使用浏览器打开，下载本作品</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 全局点击遮罩，用于点击空白处关闭二维码 -->
  <view class="mask" wx:if="{{qrCodeUrl}}" bindtap="onCloseQrCode" catchtouchmove="preventScroll"></view>

  <view class="canvas-wrap">
    <view class="canvas-container" style="{{canvasContainerStyle}}">
      <!-- 常驻背景图（最底层） -->
      <image 
        wx:if="{{permanentBackgroundImage}}" 
        src="{{permanentBackgroundImage}}" 
        class="canvas-bg permanent-bg" 
        mode="scaleToFill"
      ></image>
      
      <!-- 原型阶段：先用 canvas 占位；真实绘制逻辑后续补齐 -->
      <canvas 
        type="2d" 
        id="paintCanvas" 
        class="canvas {{permanentBackgroundImage ? 'transparent' : ''}}"
        hidden="{{isCanvasHidden}}"
        bindtouchstart="onTouchStart"
        bindtouchmove="onTouchMove"
        bindtouchend="onTouchEnd"
        bindtouchcancel="onTouchEnd"
      ></canvas>
      
      <!-- 快照图片，用于在打开工具面板时替代 Canvas，避免原生组件遮挡 -->
      <image 
        wx:if="{{isCanvasHidden}}" 
        src="{{snapshotUrl}}" 
        class="canvas-snapshot" 
        mode="scaleToFill"
      ></image>
    </view>
  </view>

  <!-- 用于生成二维码的隐藏 Canvas -->
  <view style="position: fixed; top: 9999px;">
    <canvas type="2d" id="qrCodeCanvas" style="width: 200px; height: 200px;"></canvas>
  </view>

  <t-popup visible="{{toolsVisible}}" placement="bottom" bind:visible-change="onToolsVisibleChange">
    <view class="sheet">
      <view class="grabber"></view>
      <view class="sheet-header">
        <view>
          <view class="sheet-title">调节</view>
        </view>
        <t-button theme="danger" variant="base" size="small" bindtap="onClear">清空画布</t-button>
      </view>

      <view class="slider-row">
        <view class="slider-card">
          <view class="slider-header">
            <text class="label">画笔大小</text>
            <text class="value">{{brushRadius}}</text>
          </view>
          <view class="slider-vertical-box">
             <t-slider vertical value="{{brushRadius}}" min="{{brushRadiusMin}}" max="{{brushRadiusMax}}" step="1" bind:change="onBrushRadiusChange" />
          </view>
        </view>

        <view class="slider-card">
          <view class="slider-header">
            <text class="label">增热速率</text>
            <text class="value">{{heatRate}}</text>
          </view>
          <view class="slider-vertical-box">
            <t-slider vertical value="{{heatRate}}" min="{{heatRateMin}}" max="{{heatRateMax}}" step="0.1" bind:change="onHeatRateChange" />
          </view>
        </view>
      </view>

    </view>
  </t-popup>

  <t-toast id="t-toast" />
</view>


# 微信小程序 PRD（需求文档）

## 1. 项目信息

- **项目名称**：热力图绘画
- **产品形态**：微信小程序
- **前端组件库**：**TDesign Weixin（必选）**
- **一句话简介**：在画布上“按住/停留越久，颜色越暖”，形成热力图风格的绘画，并支持保存与多级撤回/重做。

## 2. 背景与目标

### 2.1 背景

传统涂鸦以“线条/笔触”为主，本项目以“热量累积”表达绘画过程：用户在某处停留越久，热量值越高，颜色越暖，从而形成视觉上更有“能量聚集”的作品。

### 2.2 产品目标

1. 提供一个低门槛、有趣的热力绘画体验（长按更暖）。
2. 提供可靠的**保存**能力（本地作品库），保证作品不丢失。
3. 支持**多级撤回/重做**，提高创作容错率。

### 2.3 成功指标（可量化，MVP 建议）

- 完成一幅作品并保存成功率 ≥ 99%（本地保存）。
- 撤回/重做操作在常见机型上响应时间 ≤ 200ms（单步）。

## 3. 用户画像与使用场景

### 3.1 目标用户

- 喜欢随手涂鸦、做小创作的用户。
- 需要快速表达“热点/热度分布”的用户（例如简单标注）。

### 3.2 典型场景

1. 用户打开小程序，在画布上按住某处，颜色逐渐变暖，形成热力聚集。
2. 用户画错了，连续撤回多个步骤，再重做到某一步。
3. 用户保存作品到作品库，稍后打开继续编辑或导出。

## 4. 需求范围

### 4.1 MVP 范围（本期必须）

- 热力绘制：触摸/拖动绘画；**点击/停留越久，颜色越暖**。
- 基础工具：清空画布、撤回、重做。
- **多级撤回/重做**：至少 50 步（可配置）。
- **保存绘画结果**：保存到本地作品库（含缩略图/元数据）。
- 作品管理：列表查看、删除、重命名、打开继续编辑。
- UI 使用 **TDesign Weixin** 实现（按钮、弹窗、列表、Toast、ActionSheet 等）。

### 4.2 非目标（本期不做）

- 云端同步/登录体系。
- 多人协作绘画。
- AI 上色/生成类能力。
- 复杂图层系统。

## 5. 体验与交互定义（核心）

### 5.1 画布与坐标

- 画布承载：小程序 `canvas`（2D）。
- 绘制坐标：以画布左上角为原点，触摸点映射到画布像素坐标。
- DPI 适配：按设备像素比（DPR）进行缩放，避免模糊。

### 5.2 “按得越久越暖”的规则（热量累积模型）

#### 5.2.1 术语

- **热量值** $H$：某像素/网格的累积值。
- **强度增量** $\Delta H$：单位时间内增加的热量。

#### 5.2.2 基本规则（可实现且解释清晰）

1. 用户触摸开始时进入“绘制状态”。
2. 在绘制状态下，每隔固定时间片 $\Delta t$（例如 16ms 或 33ms），对触摸点附近半径 $r$ 的区域增加热量：
   - 中心点增量最大，向外衰减（高斯/线性均可）。
3. 同一位置停留时间越长，累计 $H$ 越大，映射到更“暖”的颜色。

#### 5.2.3 颜色映射（可配置）

- 将热量值归一化为 $v \in [0,1]$：
  $$ v = \min(1, H / H_{max}) $$
- 颜色梯度从冷到暖：
  - 冷：蓝/青
  - 中：绿/黄
  - 暖：橙/红
- 透明度可与 $v$ 同步（可选），让叠加更自然。

#### 5.2.4 画笔参数（MVP 可调）

- 画笔半径：默认 18px（范围 6~60）。
- 增热速率：默认 1.0（范围 0.2~3.0）。
- 最大热量：默认 100（影响“多久到最暖”）。

### 5.3 手势与操作

- 单指：绘制（按住/拖动）。
- 轻触并快速抬起：仍会产生一次短时增热（最小笔触）。
- 多指：MVP 不支持缩放/旋转；多指触控时提示“暂不支持多指缩放”。

### 5.4 撤回与重做（多级）

#### 5.4.1 行为定义

- **撤回**：回到上一个历史状态。
- **重做**：在撤回后，恢复到下一个历史状态。

#### 5.4.2 历史栈规则

- 维护两个栈：`undoStack`、`redoStack`。
- 每次完成一次“可撤回操作”（见 5.4.3）后：
  - 将当前快照压入 `undoStack`。
  - 清空 `redoStack`。
- 点击撤回：
  - 当前状态压入 `redoStack`，从 `undoStack` 弹出并恢复。
- 点击重做：
  - 当前状态压入 `undoStack`，从 `redoStack` 弹出并恢复。
- 栈容量：默认 50，超过后丢弃最旧快照。

#### 5.4.3 “可撤回操作”的粒度（关键）

为避免“每一帧都入栈”导致内存爆炸，本项目按**笔画（stroke）**入栈：

- 触摸开始（touchstart）到触摸结束（touchend/cancel）为一次笔画。
- 笔画结束时生成一次快照并入 `undoStack`。

### 5.5 保存与作品库

#### 5.5.1 保存内容

- 位图结果（用于预览/导出）：PNG。
- 可编辑数据（用于继续编辑）：保存热量数据/网格数据或渲染所需最小集合。
- 元数据：
  - id（UUID）
  - 名称
  - 创建时间/更新时间
	- 画布尺寸
	- 画笔参数（半径/速率/梯度版本）
	- 缩略图路径

#### 5.5.2 保存位置与方式（MVP 推荐）

- 使用小程序本地存储：
	- 元数据与作品索引：`wx.setStorage` / `wx.setStorageSync`
	- 文件：`wx.getFileSystemManager()` 写入到本地用户目录（如 `wx.env.USER_DATA_PATH`）
- 导出到相册（可选开关功能）：需要 `scope.writePhotosAlbum` 授权。

#### 5.5.3 保存时机

- 手动保存：点击“保存”按钮。
- 自动保存（建议增强）：
	- 用户从编辑页返回时，如未保存则提示“是否保存”。
	- 或每 N 秒/每次笔画结束进行草稿保存（可配置，默认关闭）。

## 6. 信息架构与页面

### 6.1 页面列表

1. **首页/作品库页**
   - 入口：新建作品、继续编辑、重命名、删除、导出
2. **绘画编辑页**
   - 画布、工具栏（撤回/重做/清空/保存）、画笔设置
3. **设置/关于（可选）**
   - 版本信息、清理缓存、反馈入口（预留）

### 6.2 路由建议

- `/pages/index/index`：作品库
- 新增：`/pages/editor/editor`（如后续实现）

## 7. UI 组件规范（TDesign Weixin）

### 7.1 必须使用的组件（示例）

- `t-button`：工具栏按钮（保存、撤回、重做、清空）
- `t-popup` / `t-dialog`：保存确认、未保存离开确认
- `t-toast`：保存成功/失败提示
- `t-slider`：画笔半径、增热速率调节
- `t-cell` / `t-cell-group`：设置项、作品元信息
- `t-action-sheet`：作品条目操作（重命名/删除/导出）

### 7.2 视觉与交互原则

- 工具栏固定在底部，避免遮挡画布。
- 关键操作（清空、删除）必须二次确认。
- 撤回不可用时置灰，并提供轻提示（Toast 可选）。

## 8. 数据结构（建议）

### 8.1 作品索引（storage）

`artworks:index`：

```json
[

  {
    "id": "uuid",
    "name": "未命名作品",
    "createdAt": 1700000000000,
    "updatedAt": 1700000000000,
    "width": 750,
    "height": 750,
    "thumbnailPath": "...",
    "dataPath": "...",
    "imagePath": "..."
  }
]
```

### 8.2 可编辑数据（文件）

两种可选方案（二选一，MVP 推荐 A）：

- **A. 网格热量（推荐）**：将画布划分为网格（例如 4px/格），保存每格热量值（更省空间）。
- **B. 全分辨率热量**：保存每像素热量（效果最好但体积大）。

## 9. 异常与边界

1. **存储空间不足**：保存失败提示，并引导删除旧作品或清理缓存。
2. **撤回栈为空/重做栈为空**：按钮置灰，不改变画布。
3. **多指触控**：不绘制并提示“暂不支持多指缩放”。
4. **导出相册未授权**：触发授权弹窗；拒绝后给出“去设置开启授权”的引导。
5. **长时间绘制性能**：若帧率下降，降低刷新频率或使用网格方案。

## 10. 非功能需求

### 10.1 性能

- 绘制过程保持流畅：目标 30fps 以上（中端机）。
- 内存：撤回快照需控量（默认 50 步），避免 OOM。

### 10.2 兼容性

- 覆盖微信基础库 2.20+（如需更低版本需另行评估）。

### 10.3 安全与隐私

- 默认仅本地存储。
- 如导出相册需说明权限用途与失败兜底。

## 11. 埋点（可选，但建议预留）

- `draw_stroke_end`：一次笔画结束（含用时、点数、参数）
- `undo_click` / `redo_click`
- `save_success` / `save_fail`（含失败原因枚举）
- `export_album_success` / `export_album_fail`

## 12. 验收标准（必须可测试）

### 12.1 热力绘制

1. 在同一位置按住 3 秒，颜色明显比按住 0.2 秒更偏暖。
2. 按住不动时，颜色随时间连续变化，不出现明显跳变（允许轻微离散）。
3. 拖动绘制时，轨迹连续，无明显断裂。

### 12.2 撤回/重做

1. 连续绘制 10 次笔画，撤回 10 次后画布回到初始状态。
2. 撤回 5 次后重做 3 次，画布状态与第（10-5+3）步一致。
3. 撤回后再绘制新笔画，重做栈被清空且重做按钮置灰。
4. 支持至少 50 级撤回（超过上限时，最早历史被丢弃但不影响后续撤回）。

### 12.3 保存与作品库

1. 保存后在作品库可看到新作品条目（含缩略图与更新时间）。
2. 关闭小程序重新进入，作品库仍存在该作品且可打开。
3. 打开已保存作品继续绘制，再次保存后更新时间更新，内容更新。
4. 删除作品后，本地索引与对应文件同时移除（或标记不可用并清理）。

### 12.4 UI 与组件库约束

1. 页面主要交互组件（按钮、弹窗、列表、滑块、提示）均来自 **TDesign Weixin**。
2. 清空画布、删除作品等破坏性操作必须二次确认。

## 13. 里程碑（建议）

- **M1**：编辑页画布 + 热力绘制模型（可画、越久越暖）
- **M2**：撤回/重做（按笔画入栈）+ 性能优化
- **M3**：保存/作品库（本地文件 + 列表管理）
- **M4（可选）**：导出相册 + 设置页

